{% extends 'home.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Total Purchases</h6>
                                    <h2 class="mb-0">{{ total_purchases }}</h2>
                                </div>
                                <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Total Users</h6>
                                    <h2 class="mb-0">{{ total_users }}</h2>
                                </div>
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Total Amount</h6>
                                    <h2 class="mb-0">₦{{ total_amount|floatformat:2 }}</h2>
                                </div>
                                <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Avg per Purchase</h6>
                                    <h2 class="mb-0">
                                        {% if total_purchases > 0 %}
                                            ₦{{ total_amount|floatformat:0 }}
                                        {% else %}
                                            ₦0
                                        {% endif %}
                                    </h2>
                                </div>
                                <i class="fas fa-chart-line fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Card -->
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>All Purchases with Images
                    </h3>
                    <span class="badge bg-light text-primary fs-6">
                        {{ total_purchases }} purchases
                    </span>
                </div>
                <div class="card-body">
                    <!-- Search and Filter Form -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <form method="get" action="{% url 'search-user-purchases' %}" class="row g-3">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" 
                                               name="search" 
                                               class="form-control form-control-lg" 
                                               placeholder="Search by username, email, name, or thrift name..." 
                                               value="{{ search_query }}">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select name="username" class="form-select form-select-lg">
                                        <option value="">All Users</option>
                                        {% for user in all_users %}
                                            <option value="{{ user.username }}" 
                                                {% if username_filter == user.username %}selected{% endif %}>
                                                {{ user.username }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-filter me-1"></i> Filter
                                    </button>
                                </div>
                            </form>
                            {% if search_query or username_filter %}
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Showing results for: 
                                        {% if search_query %}"{{ search_query }}"{% endif %}
                                        {% if username_filter %}{% if search_query %} and {% endif %}User: "{{ username_filter }}"{% endif %}
                                        <a href="{% url 'search-user-purchases' %}" class="ms-2 text-danger">
                                            <i class="fas fa-times"></i> Clear filters
                                        </a>
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Messages Display -->
                    {% if messages %}
                        <div class="mb-4">
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Purchases List -->
                    {% if purchases %}
                        <div class="row">
                            {% for purchase in purchases %}
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 border shadow-sm">
                                        <!-- Card Header -->
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1">
                                                        <i class="fas fa-user-circle me-2 text-primary"></i>
                                                        {{ purchase.user.username }}
                                                        <small class="text-muted ms-2">(#{{ purchase.id }})</small>
                                                    </h5>
                                                    <p class="mb-0">
                                                        <small class="text-muted">
                                                            <i class="far fa-calendar me-1"></i>
                                                            {{ purchase.datepurchased|date:"M d, Y H:i" }}
                                                        </small>
                                                    </p>
                                                </div>
                                                <span class="badge bg-info">
                                                    ₦{{ purchase.total_price|floatformat:2 }}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Card Body -->
                                        <div class="card-body">
                                            <!-- Thrift Info -->
                                            <div class="mb-3">
                                                <h6 class="text-primary">
                                                    <i class="fas fa-gift me-2"></i>
                                                    {{ purchase.thrift.thriftname }}
                                                </h6>
                                                <p class="mb-2 text-muted small">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    {{ purchase.thrift.thriftdescription|truncatewords:15 }}
                                                </p>
                                                <div class="d-flex justify-content-between small">
                                                    <span>
                                                        <i class="fas fa-box me-1"></i>
                                                        Qty: {{ purchase.quantity }}
                                                    </span>
                                                    <span>
                                                        <i class="fas fa-tag me-1"></i>
                                                        Unit: ₦{{ purchase.thrift.thriftprice|floatformat:2 }}
                                                    </span>
                                                    <span>
                                                        <i class="fas fa-images me-1"></i>
                                                        Images: {{ purchase.images_uploaded }}/{{ purchase.max_images_allowed }}
                                                    </span>
                                                </div>
                                                <!-- Progress Bar -->
                                                <div class="progress mt-2" style="height: 6px;">
                                                    <div class="progress-bar {% if purchase.can_upload_more %}bg-warning{% else %}bg-success{% endif %}" 
                                                         style="width: {{ purchase.upload_progress }}%"
                                                         title="{{ purchase.upload_progress|floatformat:0 }}% complete">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Images Section -->
                                            <div class="border-top pt-3 mt-3">
                                                <h6 class="mb-2">
                                                    <i class="fas fa-camera me-2"></i>
                                                    Uploaded Images
                                                    <small class="text-muted">({{ purchase.images.all|length }})</small>
                                                </h6>
                                                {% if purchase.images.all %}
                                                    <div class="row g-2">
                                                        {% for image in purchase.images.all|slice:":6" %}
                                                            <div class="col-4 col-md-3">
                                                                <div class="position-relative">
                                                                    <img src="{{ image.image.url }}" 
                                                                         class="img-fluid rounded border" 
                                                                         alt="{{ image.caption|default:'Purchase image' }}"
                                                                         style="height: 80px; width: 100%; object-fit: cover; cursor: pointer;"
                                                                         onclick="openImageModal('{{ image.image.url }}', '{{ image.caption|default:"" }}')">
                                                                    {% if image.caption %}
                                                                        <div class="text-truncate small mt-1" title="{{ image.caption }}">
                                                                            {{ image.caption|truncatechars:20 }}
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                        {% if purchase.images.all|length > 6 %}
                                                            <div class="col-4 col-md-3">
                                                                <div class="d-flex align-items-center justify-content-center h-100">
                                                                    <span class="badge bg-secondary">
                                                                        +{{ purchase.images.all|length|add:"-6" }} more
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-light py-2 mb-0">
                                                        <small class="text-muted">
                                                            <i class="far fa-image me-1"></i>
                                                            No images uploaded for this purchase
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Delete Button Section -->
                                            <div class="border-top pt-3 mt-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="text-muted small">
                                                        <i class="fas fa-database me-1"></i>
                                                        Purchase ID: {{ purchase.id }}
                                                    </div>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-danger delete-btn" 
                                                            data-purchase-id="{{ purchase.id }}"
                                                            data-user="{{ purchase.user.username }}"
                                                            data-thrift="{{ purchase.thrift.thriftname }}"
                                                            data-quantity="{{ purchase.quantity }}"
                                                            data-total="₦{{ purchase.total_price|floatformat:2 }}"
                                                            data-images="{{ purchase.images.all|length }}"
                                                            data-date="{{ purchase.datepurchased|date:'F d, Y H:i' }}">
                                                        <i class="fas fa-trash me-1"></i> Delete Purchase
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Card Footer -->
                                        <div class="card-footer bg-transparent border-top">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    <i class="fas fa-id-card me-1"></i>
                                                    User ID: {{ purchase.user.id }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="fas fa-gift me-1"></i>
                                                    Thrift ID: {{ purchase.thrift.id }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Pagination -->
                        {% if purchases.paginator.num_pages > 1 %}
                            <nav aria-label="Page navigation" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    {% if purchases.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if username_filter %}&username={{ username_filter }}{% endif %}">
                                                <i class="fas fa-angle-double-left"></i>
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ purchases.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if username_filter %}&username={{ username_filter }}{% endif %}">
                                                <i class="fas fa-angle-left"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    
                                    <li class="page-item active">
                                        <span class="page-link">
                                            Page {{ purchases.number }} of {{ purchases.paginator.num_pages }}
                                        </span>
                                    </li>
                                    
                                    {% if purchases.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ purchases.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if username_filter %}&username={{ username_filter }}{% endif %}">
                                                <i class="fas fa-angle-right"></i>
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ purchases.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if username_filter %}&username={{ username_filter }}{% endif %}">
                                                <i class="fas fa-angle-double-right"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <!-- No Purchases Message -->
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No purchases found</h4>
                            {% if search_query or username_filter %}
                                <p class="text-muted">Try adjusting your search criteria</p>
                            {% else %}
                                <p class="text-muted">No purchases have been made yet</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Single Reusable Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                
                <p>Are you sure you want to delete this purchase?</p>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr>
                                <th width="40%">User:</th>
                                <td id="modalUser"></td>
                            </tr>
                            <tr>
                                <th>Thrift:</th>
                                <td id="modalThrift"></td>
                            </tr>
                            <tr>
                                <th>Quantity:</th>
                                <td id="modalQuantity"></td>
                            </tr>
                            <tr>
                                <th>Total:</th>
                                <td class="fw-bold" id="modalTotal"></td>
                            </tr>
                            <tr>
                                <th>Images:</th>
                                <td>
                                    <span class="badge bg-warning text-dark" id="modalImages"></span>
                                </td>
                            </tr>
                            <tr>
                                <th>Date:</th>
                                <td id="modalDate"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <form method="post" action="" id="deleteForm" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="search" id="deleteSearch" value="{{ search_query }}">
                    <input type="hidden" name="username" id="deleteUsername" value="{{ username_filter }}">
                    <input type="hidden" name="page" id="deletePage" value="{{ request.GET.page }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i> Yes, Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Preview">
                <p id="imageCaption" class="mt-3"></p>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .progress {
        background-color: #f0f0f0;
    }
    .image-thumbnail {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .image-thumbnail:hover {
        transform: scale(1.05);
    }
    .badge {
        font-size: 0.85em;
    }
    .pagination .page-link {
        color: #495057;
    }
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .btn-danger {
        transition: all 0.2s;
    }
    .btn-danger:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }
    .modal-header.bg-danger {
        background-color: #dc3545 !important;
    }
</style>

<script>
    // Store modal instance for reuse
    let deleteModalInstance = null;
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modals
        const deleteModalElement = document.getElementById('deleteModal');
        deleteModalInstance = new bootstrap.Modal(deleteModalElement);
        
        const imageModalElement = document.getElementById('imageModal');
        const imageModalInstance = new bootstrap.Modal(imageModalElement);
        
        // Get filter values
        const searchInput = document.querySelector('input[name="search"]');
        const usernameSelect = document.querySelector('select[name="username"]');
        
        // Set up delete button click handlers
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Get data from button attributes
                const purchaseId = this.getAttribute('data-purchase-id');
                const user = this.getAttribute('data-user');
                const thrift = this.getAttribute('data-thrift');
                const quantity = this.getAttribute('data-quantity');
                const total = this.getAttribute('data-total');
                const images = this.getAttribute('data-images');
                const date = this.getAttribute('data-date');
                
                // Update modal content
                document.getElementById('modalUser').textContent = user;
                document.getElementById('modalThrift').textContent = thrift;
                document.getElementById('modalQuantity').textContent = quantity;
                document.getElementById('modalTotal').textContent = total;
                document.getElementById('modalImages').textContent = images + ' image(s) will be deleted';
                document.getElementById('modalDate').textContent = date;
                
                // Update form action
                const deleteForm = document.getElementById('deleteForm');
                deleteForm.action = `/delete-purchase/${purchaseId}/`;
                
                // Update filter values
                document.getElementById('deleteSearch').value = searchInput ? searchInput.value : '';
                document.getElementById('deleteUsername').value = usernameSelect ? usernameSelect.value : '';
                document.getElementById('deletePage').value = new URLSearchParams(window.location.search).get('page') || '';
                
                // Show modal immediately
                deleteModalInstance.show();
            });
        });
        
        // Set up image click handlers
        document.querySelectorAll('[onclick^="openImageModal"]').forEach(img => {
            const onclickAttr = img.getAttribute('onclick');
            const match = onclickAttr.match(/openImageModal\('([^']+)', '([^']*)'\)/);
            if (match) {
                const imageUrl = match[1];
                const caption = match[2];
                
                img.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('modalImage').src = imageUrl;
                    document.getElementById('imageCaption').textContent = caption;
                    imageModalInstance.show();
                });
                
                // Remove the onclick attribute to avoid conflicts
                img.removeAttribute('onclick');
            }
        });
        
        // Auto-close alerts after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert:not(.alert-danger)');
            alerts.forEach(function(alert) {
                bootstrap.Alert.getOrCreateInstance(alert).close();
            });
        }, 5000);
    });
    
    // Pre-initialize modals on window load
    window.addEventListener('load', function() {
        // Ensure modal is ready by pre-initializing
        const deleteModalElement = document.getElementById('deleteModal');
        if (deleteModalElement && !deleteModalInstance) {
            deleteModalInstance = new bootstrap.Modal(deleteModalElement);
        }
        
        // Ensure buttons are responsive
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.style.cursor = 'pointer';
        });
    });
</script>
{% endblock %}